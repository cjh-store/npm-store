name: ðŸ§ª Test Publish Workflow

on:
  # åªåœ¨æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œæµ‹è¯•
  workflow_dispatch:
    inputs:
      test_type:
        description: 'æµ‹è¯•ç±»åž‹'
        required: true
        default: 'dry-run'
        type: choice
        options:
          - 'dry-run'
          - 'build-only'
          - 'auth-check'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”„ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      - name: ðŸ“¦ Install Dependencies
        run: yarn install --frozen-lockfile

      - name: âœ… Auth Check Test
        if: github.event.inputs.test_type == 'auth-check'
        run: |
          echo "ðŸ”§ æµ‹è¯• NPM è®¤è¯..."
          npm whoami
          echo "âœ… NPM ç”¨æˆ·éªŒè¯æˆåŠŸ: $(npm whoami)"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ”¨ Build Test
        if: github.event.inputs.test_type == 'build-only' || github.event.inputs.test_type == 'dry-run'
        run: |
          echo "ðŸ”¨ æµ‹è¯•æž„å»ºæµç¨‹..."

          # æµ‹è¯•cc-vite-progressæž„å»º
          if [ -f "packages/cc-vite-progress/package.json" ]; then
            echo "ðŸ“¦ æµ‹è¯•æž„å»º cc-vite-progress..."
            cd packages/cc-vite-progress && yarn build && cd ../..
          fi

          # æµ‹è¯•fetch-event-sourceæž„å»º
          if [ -f "packages/fetch-event-source/package.json" ]; then
            echo "ðŸ“¦ æµ‹è¯•æž„å»º fetch-event-source..."
            cd packages/fetch-event-source && npm run build && cd ../..
          fi

          # æµ‹è¯•git-proæž„å»º
          if [ -f "packages/git-pro/package.json" ]; then
            echo "ðŸ“¦ æµ‹è¯•æž„å»º git-pro..."
            cd packages/git-pro && yarn build && cd ../..
          fi

          echo "âœ… æ‰€æœ‰æž„å»ºæµ‹è¯•é€šè¿‡"

      - name: ðŸ§ª Dry Run Test
        if: github.event.inputs.test_type == 'dry-run'
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ðŸ§ª æ‰§è¡Œ Lerna å‘å¸ƒé¢„æ¼”..."

          # é…ç½®git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # é…ç½®npm
          npm config set registry https://registry.npmjs.org/

          # æ‰§è¡Œdry-run
          npx lerna publish --conventional-commits --no-verify-access --yes --dry-run

          echo "âœ… Dry run æµ‹è¯•å®Œæˆ"

      - name: ðŸ“Š Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª æµ‹è¯•ç»“æžœæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æµ‹è¯•ç±»åž‹**: ${{ github.event.inputs.test_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Nodeç‰ˆæœ¬**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Yarnç‰ˆæœ¬**: $(yarn --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **Lernaç‰ˆæœ¬**: $(npx lerna --version)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.test_type }}" == "auth-check" ]]; then
            echo "### ðŸ” è®¤è¯æµ‹è¯•" >> $GITHUB_STEP_SUMMARY
            echo "- NPMç”¨æˆ·: $(npm whoami 2>/dev/null || echo 'âŒ è®¤è¯å¤±è´¥')" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä¸‹ä¸€æ­¥" >> $GITHUB_STEP_SUMMARY
          echo "å¦‚æžœæµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥ä½¿ç”¨ä¸»å‘å¸ƒå·¥ä½œæµè¿›è¡Œæ­£å¼å‘å¸ƒã€‚" >> $GITHUB_STEP_SUMMARY