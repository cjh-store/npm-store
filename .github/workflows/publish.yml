name: ğŸ“¦ Publish Packages

on:
  # æ¨é€è§¦å‘ï¼šä¸»åˆ†æ”¯è‡ªåŠ¨å‘å¸ƒ + æ ‡ç­¾å‘å¸ƒ
  push:
    branches:
      - main
      - master
    tags:
      - '*@*'  # æ ¼å¼ package-name@version

  # æ‰‹åŠ¨è§¦å‘ï¼šé€‰æ‹©æ€§å‘å¸ƒ
  workflow_dispatch:
    inputs:
      packages:
        description: 'é€‰æ‹©è¦å‘å¸ƒçš„åŒ… (å¤šé€‰ç”¨é€—å·åˆ†éš”ï¼Œallè¡¨ç¤ºå…¨éƒ¨)'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'cc-cli-run'
          - 'cc-git-tag'
          - 'cc-vite-progress'
          - '@cjh0/fetch-event-source'
          - '@cjh0/git-pro'

      force:
        description: 'å¼ºåˆ¶å‘å¸ƒ (è·³è¿‡ç‰ˆæœ¬æ£€æŸ¥)'
        required: false
        default: false
        type: boolean

jobs:
  publish:
    runs-on: ubuntu-latest
    if: "github.event_name == 'workflow_dispatch' || github.event_name == 'push' && (contains(github.ref, 'tags') || !contains(github.event.head_commit.message, '[skip ci]'))"

    permissions:
      contents: write      # åˆ›å»ºreleaseså’Œæ ‡ç­¾
      issues: write       # semantic-releaseéœ€è¦
      pull-requests: write # semantic-releaseéœ€è¦
      id-token: write     # npm provenance

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ”„ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œlernaéœ€è¦
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'yarn'

      # 3. éªŒè¯NPMè®¤è¯ï¼ˆå€Ÿé‰´ccé¡¹ç›®ï¼‰
      - name: âœ… Verify NPM Authentication
        run: |
          echo "ğŸ”§ éªŒè¯ NPM è®¤è¯..."

          # æ£€æŸ¥ NPM_TOKEN æ˜¯å¦å­˜åœ¨
          if [ -z "$NPM_TOKEN" ]; then
            echo "âŒ NPM_TOKEN secret æœªé…ç½®ï¼"
            echo "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½®ï¼š"
            echo "1. è®¿é—® https://www.npmjs.com/settings/tokens"
            echo "2. ç”Ÿæˆ Automation ç±»å‹çš„ token"
            echo "3. åœ¨ GitHub Settings > Secrets ä¸­æ·»åŠ  NPM_TOKEN"
            exit 1
          fi

          # éªŒè¯ NPM ç™»å½•
          npm whoami || {
            echo "âŒ NPM è®¤è¯å¤±è´¥ï¼è¯·æ£€æŸ¥ token æ˜¯å¦æœ‰æ•ˆ"
            echo "Token å‰ç¼€: ${NPM_TOKEN:0:8}..."
            exit 1
          }

          echo "âœ… NPM ç”¨æˆ·: $(npm whoami)"
          echo "âœ… NPM è®¤è¯éªŒè¯æˆåŠŸ"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 4. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ Install Dependencies
        run: yarn install --frozen-lockfile
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      # 5. è´¨é‡æ£€æŸ¥ - æ„å»ºæ‰€æœ‰åŒ…
      - name: ğŸ”¨ Build Packages
        run: |
          echo "ğŸ”¨ å¼€å§‹æ„å»ºéœ€è¦æ„å»ºçš„åŒ…..."

          # æ£€æŸ¥å¹¶æ„å»ºcc-vite-progress
          if [ -f "packages/cc-vite-progress/package.json" ]; then
            echo "ğŸ“¦ æ„å»º cc-vite-progress..."
            cd packages/cc-vite-progress && yarn build && cd ../..
          fi

          # æ£€æŸ¥å¹¶æ„å»ºfetch-event-source
          if [ -f "packages/fetch-event-source/package.json" ]; then
            echo "ğŸ“¦ æ„å»º fetch-event-source..."
            cd packages/fetch-event-source && npm run build && cd ../..
          fi

          # æ£€æŸ¥å¹¶æ„å»ºgit-pro
          if [ -f "packages/git-pro/package.json" ]; then
            echo "ğŸ“¦ æ„å»º git-pro..."
            cd packages/git-pro && yarn build && cd ../..
          fi

          echo "âœ… æ„å»ºå®Œæˆ"

      # 6. Gité…ç½® (lernaéœ€è¦)
      - name: âš™ï¸ Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 7. è§£æè§¦å‘æ–¹å¼å’ŒåŒ…
      - name: ğŸ¯ Parse Trigger & Packages
        id: parse
        run: |
          echo "ğŸ” åˆ†æè§¦å‘æ–¹å¼..."

          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            # æ ‡ç­¾è§¦å‘ï¼šè§£æåŒ…å
            TAG_NAME="${{ github.ref_name }}"
            if [[ $TAG_NAME =~ ^(.+)@(.+)$ ]]; then
              PACKAGE_NAME="${BASH_REMATCH[1]}"
              PACKAGE_VERSION="${BASH_REMATCH[2]}"
              echo "trigger=tag" >> $GITHUB_OUTPUT
              echo "package=$PACKAGE_NAME" >> $GITHUB_OUTPUT
              echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
              echo "ğŸ·ï¸ æ ‡ç­¾è§¦å‘: $PACKAGE_NAME@$PACKAGE_VERSION"
            else
              echo "âŒ æ ‡ç­¾æ ¼å¼é”™è¯¯ï¼Œåº”ä¸º package@version"
              exit 1
            fi

          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # æ‰‹åŠ¨è§¦å‘
            echo "trigger=manual" >> $GITHUB_OUTPUT
            echo "packages=${{ github.event.inputs.packages }}" >> $GITHUB_OUTPUT
            echo "force=${{ github.event.inputs.force }}" >> $GITHUB_OUTPUT
            echo "ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘: ${{ github.event.inputs.packages }}"

          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # è‡ªåŠ¨è§¦å‘ï¼šæ¨é€åˆ°ä¸»åˆ†æ”¯
            echo "trigger=auto" >> $GITHUB_OUTPUT
            echo "ğŸ¤– è‡ªåŠ¨è§¦å‘: æ£€æµ‹å˜æ›´å¹¶å‘å¸ƒ"

          else
            echo "âŒ æœªçŸ¥è§¦å‘æ–¹å¼"
            exit 1
          fi

      # 8. æ™ºèƒ½å‘å¸ƒåŒ…
      - name: ğŸš€ Publish Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ç¡®ä¿npmå·²ç™»å½•
          echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc

          # åˆ‡æ¢åˆ°npmæº
          npm config set registry https://registry.npmjs.org/

          TRIGGER="${{ steps.parse.outputs.trigger }}"

          if [[ "$TRIGGER" == "tag" ]]; then
            # æ ‡ç­¾è§¦å‘ï¼šå‘å¸ƒç‰¹å®šåŒ…
            PACKAGE_NAME="${{ steps.parse.outputs.package }}"
            echo "ğŸ¯ å‘å¸ƒå•ä¸ªåŒ…: $PACKAGE_NAME"
            npx lerna publish from-package --no-verify-access --yes --scope="$PACKAGE_NAME"

          elif [[ "$TRIGGER" == "manual" ]]; then
            # æ‰‹åŠ¨è§¦å‘ï¼šæ ¹æ®é€‰æ‹©å‘å¸ƒ
            PACKAGES="${{ steps.parse.outputs.packages }}"

            if [[ "$PACKAGES" == "all" ]]; then
              echo "ğŸš€ å‘å¸ƒæ‰€æœ‰å·²å˜æ›´çš„åŒ…"
              npx lerna publish --conventional-commits --no-verify-access --yes
            else
              echo "ğŸ¯ å‘å¸ƒæŒ‡å®šåŒ…: $PACKAGES"
              # å¤„ç†å¤šä¸ªåŒ…çš„æƒ…å†µ
              IFS=',' read -ra PKG_ARRAY <<< "$PACKAGES"
              for pkg in "${PKG_ARRAY[@]}"; do
                pkg=$(echo "$pkg" | xargs)  # å»é™¤ç©ºæ ¼
                echo "ğŸ“¦ å‘å¸ƒåŒ…: $pkg"
                npx lerna publish from-package --no-verify-access --yes --scope="$pkg"
              done
            fi

          elif [[ "$TRIGGER" == "auto" ]]; then
            # è‡ªåŠ¨è§¦å‘ï¼šåŸºäºcommitä¿¡æ¯å‘å¸ƒå˜æ›´çš„åŒ…
            echo "ğŸ¤– è‡ªåŠ¨æ£€æµ‹å¹¶å‘å¸ƒå·²å˜æ›´çš„åŒ…"
            npx lerna publish --conventional-commits --no-verify-access --yes

          else
            echo "âŒ æœªçŸ¥è§¦å‘ç±»å‹: $TRIGGER"
            exit 1
          fi

      # 9. å‘å¸ƒç»“æœé€šçŸ¥
      - name: ğŸ“Š Publish Summary
        if: always()
        run: |
          echo "## ğŸ“¦ å‘å¸ƒæ€»ç»“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TRIGGER="${{ steps.parse.outputs.trigger }}"

          echo "### ğŸ¯ è§¦å‘ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          if [[ "$TRIGGER" == "tag" ]]; then
            echo "- **è§¦å‘æ–¹å¼**: ğŸ·ï¸ æ ‡ç­¾è§¦å‘" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒåŒ…**: ${{ steps.parse.outputs.package }}@${{ steps.parse.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "$TRIGGER" == "manual" ]]; then
            echo "- **è§¦å‘æ–¹å¼**: ğŸ–±ï¸ æ‰‹åŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒåŒ…**: ${{ steps.parse.outputs.packages }}" >> $GITHUB_STEP_SUMMARY
          elif [[ "$TRIGGER" == "auto" ]]; then
            echo "- **è§¦å‘æ–¹å¼**: ğŸ¤– è‡ªåŠ¨è§¦å‘" >> $GITHUB_STEP_SUMMARY
            echo "- **å‘å¸ƒèŒƒå›´**: æ£€æµ‹åˆ°å˜æ›´çš„åŒ…" >> $GITHUB_STEP_SUMMARY
          fi

          echo "- **æ‰§è¡ŒçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ‰§è¡Œæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **Nodeç‰ˆæœ¬**: $(node --version)" >> $GITHUB_STEP_SUMMARY
          echo "- **NPMç”¨æˆ·**: $(npm whoami 2>/dev/null || echo 'N/A')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ğŸ”— å¿«é€Ÿé“¾æ¥" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“¦ NPM Registry](https://www.npmjs.com/search?q=%40cjh0)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ“ Lernaæ–‡æ¡£](https://lerna.js.org/)" >> $GITHUB_STEP_SUMMARY
          echo "- [ğŸ·ï¸ é¡¹ç›®Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY

      # 10. é€šçŸ¥å¤±è´¥
      - name: ğŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "## âŒ å‘å¸ƒå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### å¸¸è§é—®é¢˜æ’æŸ¥" >> $GITHUB_STEP_SUMMARY
          echo "1. **NPM Token**: æ£€æŸ¥ \`NPM_TOKEN\` secret æ˜¯å¦æ­£ç¡®é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "2. **æƒé™é—®é¢˜**: ç¡®è®¤è´¦å·å¯¹åŒ…æœ‰å‘å¸ƒæƒé™" >> $GITHUB_STEP_SUMMARY
          echo "3. **ç‰ˆæœ¬å†²çª**: æ£€æŸ¥åŒ…ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          echo "4. **æ„å»ºå¤±è´¥**: æŸ¥çœ‹æ„å»ºæ­¥éª¤çš„é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“‹ è¯·æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†æ—¥å¿—è¿›è¡Œé—®é¢˜æ’æŸ¥ã€‚"